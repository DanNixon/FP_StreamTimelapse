<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>GPS Log Viewer</title>
    <style type="text/css">
		html, body {
			height: 100%;
			margin: 0px;
			padding: 0px
		}
		#map-canvas, #map_canvas {
			height: 100%;
			width: 100%;
		}
		#controls {
			
		}
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script>
		var map;
		var markers;
		var points;
		var gps_path;
		var gps_points;
		var line_resolution = 50;
		
		function initialize() {
			var default_pos = new google.maps.LatLng(53, -1);
			var mapOptions = {
				zoom: 5,
				center: default_pos,
				mapTypeId: google.maps.MapTypeId.ROAD
			};

			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

			markers = new Array();
			gps_path = new Array();
			
			add_gps_log("http://37.139.30.37/gps.log");
		}
		
		function set_markers_map(map) {
			for (var i = 0; i < markers.length; i++) {
				markers[i].setMap(map);
			}
		}
		
		function add_gps_log(log_file) {
			set_markers_map(null);
			for(var p = 0; p < gps_path.length; p++) {
				gps_path[p].setMap(null);
			}
			gps_path = new Array();
			markers = new Array();
			points = new Array();
			
			var raw_data = httpGet(log_file);
			gps_points = parse_csv(raw_data, ",");
			
			var point_data = gps_points[0];
			var point_pos = new google.maps.LatLng(parseFloat(point_data[0]), parseFloat(point_data[1]));
			var m = new google.maps.Marker({
				position: point_pos,
				map: map,
				title: "Log Start",
				icon: {
					path: google.maps.SymbolPath.CIRCLE,
					strokeColor: "green",
					scale: 4
				}
			});
			markers.push(m);

			
			for(var p = 0; p < gps_points.length - (2 + line_resolution); p += line_resolution) {
				var p_pts = new Array();
				
				var point_data = gps_points[p];
				var point_pos = new google.maps.LatLng(parseFloat(point_data[0]), parseFloat(point_data[1]));
				p_pts.push(point_pos);
				
				var next_point_data = gps_points[p + line_resolution];
				var next_point_pos = new google.maps.LatLng(parseFloat(next_point_data[0]), parseFloat(next_point_data[1]));
				p_pts.push(next_point_pos);
				
				path_n = new google.maps.Polyline({
					path: p_pts,
					strokeColor: "rgb(150, 100, 220)",
					strokeOpacity: 1.0,
					strokeWeight: 3
				});
			
				path_n.setMap(map);
				
				gps_path.push(path_n);
			}
			
			
			var point_data = gps_points[gps_points.length - 2];
			var point_pos = new google.maps.LatLng(parseFloat(point_data[0]), parseFloat(point_data[1]));
			var m = new google.maps.Marker({
				position: point_pos,
				map: map,
				title: "Log End",
				icon: {
					path: google.maps.SymbolPath.CIRCLE,
					strokeColor: "red",
					scale: 4
				}
			});
			markers.push(m);
		}
		
		function httpGet(theUrl)
		{
			var xmlHttp = null;
			xmlHttp = new XMLHttpRequest();
			xmlHttp.open("GET", theUrl, false);
			xmlHttp.send(null);
			return xmlHttp.responseText;
		}
		
		function parse_csv( strData, strDelimiter ){
			strDelimiter = (strDelimiter || ",");
			var objPattern = new RegExp(
				(
					"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
					"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
					"([^\"\\" + strDelimiter + "\\r\\n]*))"
				),
				"gi"
				);
			var arrData = [[]];
			var arrMatches = null;
			while (arrMatches = objPattern.exec( strData )){
				var strMatchedDelimiter = arrMatches[ 1 ];
				if (
					strMatchedDelimiter.length &&
					(strMatchedDelimiter != strDelimiter)
					){
					arrData.push( [] );
				}
				if (arrMatches[ 2 ]){
					var strMatchedValue = arrMatches[ 2 ].replace(
						new RegExp( "\"\"", "g" ),
						"\""
						);
				} else {
					var strMatchedValue = arrMatches[ 3 ];
				}
				arrData[ arrData.length - 1 ].push( strMatchedValue );
			}
			return( arrData );
		}

		google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="controls">
		
    </div>
  </body>
</html>
